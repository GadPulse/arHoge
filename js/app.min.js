function enablestart(){var e=document.getElementById("startbutton");e.value="start",e.disabled=null}function adjustVideoProportions(){var e=vid.clientWidth,t=vid.clientHeight,a=content.clientWidth,c=a/e;vid.width=overlay.width=deco.width=a,vid.height=overlay.height=deco.height=t*c}function gumSuccess(e){"srcObject"in vid?vid.srcObject=e:vid.src=window.URL&&window.URL.createObjectURL(e),vid.onloadedmetadata=function(){adjustVideoProportions(),vid.play()},vid.onresize=function(){adjustVideoProportions(),trackingStarted&&(ctrack.stop(),ctrack.reset(),ctrack.start(vid))}}function gumFail(){alert("There was some problem trying to fetch video from your webcam.")}function OnclickFunc(){Trigger=!0,score=-1,currentScore=-1,setTimeout(function(){Trigger&&(isMeasurementFailed=!0,isMeasurementSuccess=!1,Trigger=!1,circle.x=40,circle.y=40,console.log("計測失敗"),drawText(3),setTimeout(function(){isMeasurementFailed=!1,drawText(4)},3e3))},5e3)}function clmtrackrLostHandler(){score=-1}function clmtrackrConvergedHandler(){if(Trigger){console.log("計測成功"),isMeasurementFailed=!1,isMeasurementSuccess=!0,isCountingScore=!0;var e=Math.floor(9999*Math.random())+0;score=e,drawText(2),CalculatePower(),Trigger=!1,setTimeout(function(){isMeasurementSuccess=!1},5e3)}}function startVideo(){vid.play(),ctrack.start(vid),trackingStarted=!0,drawLoop()}function drawLoop(){if(requestAnimFrame(drawLoop),overlayCC.clearRect(0,0,overlay.width,overlay.height),decoCanvasContext.clearRect(0,0,decoCanvas.width,decoCanvas.height),drawText(!Trigger||isMeasurementSuccess||isMeasurementFailed?!Trigger&&isMeasurementSuccess?2:!Trigger&&isMeasurementFailed?3:4:1),ctrack.getCurrentPosition())if(ctrack.draw(overlay),Trigger){var e=ctrack.getCurrentPosition();circle.x=e[13][0]+(e[1][0]-e[13][0])/2,circle.y=e[13][1]+(e[1][1]-e[13][1])/2,circle.radius>CalculateLength(1,13,e)/2*1?circle.radius-=5:circle.radius=CalculateLength(1,13,e)/2*2,drawCircle(circle.x,circle.y,circle.radius),decoCanvasContext.beginPath(),decoCanvasContext.moveTo(circle.x-circle.radius,circle.y),decoCanvasContext.lineTo(circle.x-circle.radius-20,circle.y-10),decoCanvasContext.lineTo(circle.x-circle.radius-20,circle.y+10),decoCanvasContext.closePath(),decoCanvasContext.fill(),decoCanvasContext.beginPath(),decoCanvasContext.moveTo(circle.x,circle.y+circle.radius),decoCanvasContext.lineTo(circle.x+10,circle.y+circle.radius+20),decoCanvasContext.lineTo(circle.x-10,circle.y+circle.radius+20),decoCanvasContext.closePath(),decoCanvasContext.fill(),decoCanvasContext.beginPath(),decoCanvasContext.moveTo(circle.x+circle.radius,circle.y),decoCanvasContext.lineTo(circle.x+circle.radius+20,circle.y-10),decoCanvasContext.lineTo(circle.x+circle.radius+20,circle.y+10),decoCanvasContext.closePath(),decoCanvasContext.fill(),decoCanvasContext.beginPath(),decoCanvasContext.moveTo(circle.x,circle.y-circle.radius),decoCanvasContext.lineTo(circle.x+10,circle.y-circle.radius-20),decoCanvasContext.lineTo(circle.x-10,circle.y-circle.radius-20),decoCanvasContext.closePath(),decoCanvasContext.fill();var t=e[33][0],a=e[33][1]-100,c=Math.floor(9999*Math.random())+0;decoCanvasContext.font="bold 5vw FontScouter",decoCanvasContext.fillStyle="rgba(0,255,0,0.8)",a>50?decoCanvasContext.fillText(c,t,a):(a=e[7][1],decoCanvasContext.fillText(c,t,a+50))}else if(score>=0){isCountingScore&&(currentScore+=Math.floor(score/30)),currentScore>=score&&(currentScore=score,isCountingScore=!1);var e=ctrack.getCurrentPosition(),t=e[33][0],a=e[33][1]-100;decoCanvasContext.font="bold 5vw FontScouter",decoCanvasContext.fillStyle="rgba(0,255,0,0.8)",a>50?decoCanvasContext.fillText(currentScore,t,a):(a=e[7][1],decoCanvasContext.fillText(currentScore,t,a+50))}}function drawCircle(e,t,a){return decoCanvas&&overlay.getContext?(decoCanvasContext.beginPath(),decoCanvasContext.lineWidth=5,decoCanvasContext.strokeStyle="rgba(0,255,0,0.2)",decoCanvasContext.arc(e,t,a,0,2*Math.PI,!0),void decoCanvasContext.stroke()):!1}function drawText(e){switch(decoCanvasContext.font="bold 3vw FontScouter",decoCanvasContext.fillStyle="rgba(0,255,0,0.8)",e){case 1:decoCanvasContext.fillText("Measuring. . .",7*decoCanvas.width/10,9*decoCanvas.height/10);break;case 2:decoCanvasContext.fillText("Success.",4*decoCanvas.width/5,9*decoCanvas.height/10);break;case 3:decoCanvasContext.fillText("Failed. . .",4*decoCanvas.width/5,9*decoCanvas.height/10);break;case 4:decoCanvasContext.fillText("Touch!this!screen",2*decoCanvas.width/5,9*decoCanvas.height/10),decoCanvasContext.fillText("to!measure!the!power. . .",2*decoCanvas.width/5,30+9*decoCanvas.height/10)}}function CalculatePower(){var e=ctrack.getCurrentPosition();if(e){var t=CalculateLength(1,13,e),a=CalculateLength(7,37,e);if(0!=t&&0!=a){var c=CalculateLength(30,25,e)/t,o=(CalculateLength(26,24,e)+CalculateLength(31,29,e))/2/a,n=(CalculateLength(25,23,e)+CalculateLength(30,28,e))/2/t,r=CalculateLength(37,62,e)/a,i=CalculateLength(39,35,e)/t,s=CalculateLength(53,47,e)/a,l=CalculateLength(50,44,e)/t,d=e[22][0]-e[21][0],C=e[22][1]-e[21][1],v=e[18][0]-e[17][0],u=e[18][1]-e[17][1],g=e[33][0]-e[62][0],h=e[33][1]-e[62][1],x=(d*g+C*h)/(Math.sqrt(d*d+C*C)*Math.sqrt(g*g+h*h)),m=(v*g+u*h)/(Math.sqrt(v*v+u*u)*Math.sqrt(g*g+h*h)),w=CalculateLength(5,7,e),f=CalculateLength(7,9,e),y=CalculateLength(9,5,e),T=w*f*y/Math.sqrt(w+f+y+(f+y-w)+(y+w-f)+(w+f-y)),M=1/T;score=Math.floor(-208035872351.522+7231623155616.85*c+7782927625.34857*o+508060866818.232*n+-417157547954.439*r+-16716610061729.6*i+-1475015553658.31*s+5650045751884.23*l+-145648699134.646*x+-1378158592850.59*m+993058938884.308*M),score=Math.abs(Math.floor(score/1e7))}}}function CalculateLength(e,t,a){return Math.sqrt((a[e][0]-a[t][0])*(a[e][0]-a[t][0])+(a[e][1]-a[t][1])*(a[e][1]-a[t][1]))}var vid=document.getElementById("videoel"),vid_width=vid.width,vid_height=vid.height,content=document.getElementById("content"),overlay=document.getElementById("overlay"),overlayCC=overlay.getContext("2d"),contents=new Array,score=-1,currentScore=-1,circle=[];circle.push({x:40,y:40,radius:50});var Trigger=!1,isMeasurementSuccess=!1,isMeasurementFailed=!1,isCountingScore=!1,isFacewireDisplayed=!1;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.msURL||window.mozURL,navigator.mediaDevices?navigator.mediaDevices.getUserMedia({video:!0}).then(gumSuccess)["catch"](gumFail):navigator.getUserMedia?navigator.getUserMedia({video:!0},gumSuccess,gumFail):alert("Your browser does not seem to support getUserMedia."),vid.addEventListener("canplay",enablestart,!1);var ctrack=new clm.tracker;ctrack.init();var trackingStarted=!1;document.addEventListener("clmtrackrConverged",clmtrackrConvergedHandler),document.addEventListener("clmtrackrLost",clmtrackrLostHandler);var decoCanvas=document.getElementById("deco"),decoCanvasContext=decoCanvas.getContext("2d");decoCanvas.addEventListener("click",OnclickFunc),$("#facewire").on("click touch",function(){isFacewireDisplayed?($("#overlay").css("visibility","hidden"),isFacewireDisplayed=!1):($("#overlay").css("visibility","visible"),isFacewireDisplayed=!0)}),stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",document.getElementById("container").appendChild(stats.domElement),document.addEventListener("clmtrackrIteration",function(){stats.update()},!1);